---
title: "02-DESeq2-etc-RKS"
author: "Laura H Spencer"
date: "01/09/2022"
output: html_document
---

```{r}
getwd()
```

### Load libraries and source scripts 

```{r, message=FALSE, warning=FALSE, results=FALSE}
source("../references/biostats.R")

# Add all required libraries that are installed with install.packages() here
list.of.packages <- c("RCurl", "tidyverse", "vegan", "pheatmap", "pastecs", "factoextra", "FactoMineR", "RColorBrewer", "tibble", "reshape2", "plotly", "cowplot", "clipr", "janitor", "ggpubr", "forcats", "apeglm", "car", "vsn")
# Add all libraries that are installed using BiocManager here
bioconductor.packages <- c("DESeq2", "WGCNA")

# Install BiocManager if needed
if(!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

# Get names of all required packages that aren't installed
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[, "Package"])]
new.bioc.packages <- bioconductor.packages[!(bioconductor.packages %in% installed.packages()[, "Package"])]
# Install all new packages
if(length(new.packages)) install.packages(new.packages)
if(length(new.bioc.packages)) BiocManager::install(new.bioc.packages)

# Load all required libraries
all.packages <- c(list.of.packages, bioconductor.packages)
lapply(all.packages, FUN = function(X) {
  do.call("require", list(X))
})

```

### Load counts and sample info 
```{r}
load(file = "../results/gene-counts") #object = counts
load(file="../data/sample.info") #object = sample.info
load(file = "../results/gene-counts-trans") #object = counts.t
load(file = "../results/gene-counts-trans-filtered") #object = counts.ts

load(file = "../references/P.plat.blast") #P.plat.blast
load(file = "../references/P.plat.blast.GO") #P.plat.blast.GO
load(file = "../references/P.plat.bestblast") #P.plat.bestblast

```

## Summary stats
```{r}
# What's the average no. of genes per sample? 
data.frame(rowSums(counts.t != 0)) %>% 
                  dplyr::rename(count.total = 1) %>% 
                  rownames_to_column(var="sample") %>% 
  summarise(mean=mean(count.total, na.rm=T), sd=sd(count.total, na.rm=T), se=sd/sqrt(length(sample)),
            min=min(count.total, na.rm=T), max=max(count.total, na.rm=T))

# No. of reads per sample? 
data.frame(rowSums(counts.t)) %>% 
                  dplyr::rename(read.total = 1) %>% 
                  rownames_to_column(var="sample") %>% #summary() 
summarise(mean=mean(read.total, na.rm=T), sd=sd(read.total, na.rm=T), se=sd/sqrt(length(sample))) #use this to average across all samples 
```


### How many genes were identified in each sample?

```{r}
ggplotly(
ggplot(data = data.frame(rowSums(counts.t != 0, na.rm=TRUE)) %>% 
                  dplyr::rename(count.total = 1) %>% 
                  rownames_to_column(var="sample")) +
           geom_bar(aes(x=sample, y=count.total), stat = "identity") + ggtitle("Total # genes by sample") + 
             theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())) 
```


## Use foa.plots to visualize data a bit: 

### In how many samples does each gene occur? 
  - The **first four plots portray the gene’ frequency of occurrence among samples** in a number of different ways – either as an empirical cumulative distribution function (ECDF) of gene occurrence or as a histogram of gene occurrence. 

### What is the mean abundance of each gene when it occurs (not averaging zeros for samples where it is absent)? 
  - The **fifth plot is an ECDF of gene mean abundance.** X-axis is samples, ranked from 1-n in terms of mean gene abundance. 
  
### Is the mean abundance of genes correlated with the number of samples they occur in? 
  - The **sixth plot is a scatter plot of frequency of occurrence against mean abundance**. Is there any apparent relationship between the two? Are the widespread genes also generally more abundant? Are there many widespread genes that occur at low abundance? Conversely, are there genes much less widespread, but abundant where they occur?

### Is the total abundance of gene in a sample correlated with the number of gene in a sample? To answer this question, first it is instructive to look at the number of gene per sample. 
  - The **eighth plot depicts the ECDF of sample richness.** Are there any interesting patterns? For example, do most samples support an average number of gene, while only a few samples supporting either very few or very many gene? Or is the pattern different?

### Second, what is the pattern in the distribution of sample total abundance? 
  - The **ninth plot is the ECDF of total sample abundance.** How does it compare to the ECDF of sample richness?

### Finally, to answer the question on the relation between total abundance and number of gene/sample ...
  - The **last plot is a scatter plot of the two variables.** Is there is relationship between the _number of genes per sample and the total abundance?_ Do gene-rich samples generally have a greater total abundance of those genes as well? 

```{r}
# note: you'll need to press return in the console for all plots 
#foa.plots(counts.ts)
```

### Merge sample key info to count data, then sort, and generate heat map for initial inspection by treatment 
```{r}
# IMPORTANT NOTE: to use data for ALL genes, use object "counts.t". To remove low-frequency genes, use object "counts.ts" 

# merge count data with sample key, reset row names as sample names, and arrange by infection, then temperature, then day 
counts.tk <- merge(x=sample.info[,c("Sample", "Tank", "Treatment", "Treatment_Tank")], by.x="Sample", y=counts.ts, by.y="row.names") %>% 
  arrange(Treatment, Tank)  %>% column_to_rownames(var="Sample") %>% droplevels()

head(counts.tk[1:24]) #check out results of merge/arrange
#counts.tk %>% dplyr::select(starts_with("evm")) #this is code to get only the gene columns 

```

# Analysis in DESeq2  

### Reformat for DESeq, ensure correct sample order for 

NOTE: It is absolutely critical that the **columns of the count matrix** and the **rows of the column data (information about samples)** are in the same order. DESeq2 will not make guesses as to which column of the count matrix belongs to which row of the column data, these must be provided to DESeq2 already in consistent order.

```{r}
all(rownames(counts.tk) == counts.tk %>% dplyr::select(starts_with("evm")) %>% t() %>% colnames()) #check that rownames of untransformed matrix match column names of transformed matrix. Should print 'TRUE' 
```

# Generate DESeq datasets with various treatment comparisons  

```{r}
dds.pH <- DESeqDataSetFromMatrix(countData = counts.tk[,grepl("evm", colnames(counts.tk))] %>% t(),
                              colData = counts.tk[,"Treatment", drop=FALSE] ,
                              design = ~ Treatment)

dds.tank <- DESeqDataSetFromMatrix(countData = counts.tk[,grepl("evm", colnames(counts.tk))] %>% t(),
                              colData = counts.tk[,"Tank", drop=FALSE] ,
                              design = ~ Tank)

dds.treat.tank <- DESeqDataSetFromMatrix(countData = counts.tk[,grepl("evm", colnames(counts.tk))] %>% t(),
                              colData = counts.tk[,"Treatment_Tank", drop=FALSE] ,
                              design = ~ Treatment_Tank)
```

## Transform data for visualization 

- Here we transform counts using a variance stabilizing transformation (VST), since we have many samples. 
- Here we use `blind=FALSE` b/c we are interested in differences explained by experimental design, and may wish to use this transformed data in downstream analyses. 
```{r}
vsd.pH <- varianceStabilizingTransformation(dds.pH, blind=FALSE)
vsd.tank <- varianceStabilizingTransformation(dds.tank, blind=FALSE)
vsd.treat.tank <- varianceStabilizingTransformation(dds.treat.tank, blind=FALSE)

# Check out effect of VSD 
meanSdPlot(assay(vsd.pH)) #check out normalized count SD by ranked mean - red line should be ~flat 
meanSdPlot(assay(normTransform(dds.pH))) #this is variance after a simple log2(n+1) transformation 

# Save vsd.pH object for late ruse 
save(vsd.pH, file = "../results/deseq2/vsd.pH")
```
### Generate heat maps before & after transformation  

NOTE: scale="column" b/c range of counts is so huge, so counts have been scaled 

```{r}
pheatmap(data.matrix(counts.tk %>% dplyr::select(starts_with("evm"))), Rowv=NA, Colv=NA, na.rm = TRUE, xlab = NA, 
                     show_colnames =FALSE, cluster_cols = FALSE, cluster_rows = TRUE, 
         annotation_colors = list(Treatment=c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")),
                     scale="column", #color=c("dodgerblue3", "goldenrod1"), 
                     main = "RKC gene counts - not transformed", annotation_row=counts.tk[,c("Treatment"), drop=FALSE])

# extract treatment info from VSD transformation 

# generate heatmap from VSD counts 
pheatmap(t(assay(vsd.pH)), Rowv=NA, Colv=NA, na.rm = TRUE, xlab = NA, scale="column", 
                     show_colnames =FALSE, cluster_cols = FALSE, cluster_rows = TRUE, 
         annotation_colors = list(Treatment=c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")),
         annotation_row=as.data.frame(colData(vsd.pH)[,c("Treatment"), drop=FALSE]), 
         main = "RKC gene counts - VSD-transformed")
```

## Save variance-stabilization normalized gene counts x sample matrix, annotated for later use 

```{r}
counts.trans <- assay(vsd.pH) %>% t() %>% as.matrix() %>% as.data.frame() %>%
  rownames_to_column(var = "Sample") %>% 
  left_join(sample.info[,c("Sample", "Treatment", "Tank", "Treatment_Tank")]) %>%
  column_to_rownames(var = "Sample") %>% 
  select(Treatment, Tank, Treatment_Tank, contains("evm")) %>% 
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
save(counts.trans, file = "../results/bowtie/counts.trans")
```


## Visualize sample clustering via PCA (after transformation)

NOTE: Hover over points to see the sample numbers

```{r}
# PCA with points color coded by pH Treatment 
#ggplotly(
  plotPCA(vsd.pH, intgroup="Treatment") + 
           ggtitle("PCA by Treatment (var-stabilizing transformed)") + 
    geom_point(size=3, aes(text=colnames(vsd.pH))) + 
  scale_color_manual(values=c("Ambient"="#2c7bb6", "Moderate"="#fdae61", "Low"="#d7191c")) +
    theme_minimal()+ stat_ellipse() 
#, tooltip = "text")

# PCA with points color coded by tank 
ggplotly(
  plotPCA(vsd.tank, intgroup="Tank") + 
           ggtitle("PCA by Tank (var-stabilizing transformed)") + 
    geom_point(size=3, aes(text=colnames(vsd.tank))) + 
   theme_minimal(), tooltip = "text")

# PCA with points color coded by treatment + tank 
#ggplotly(
  plotPCA(vsd.treat.tank, intgroup="Treatment_Tank") + 
           ggtitle("PCA by Treatment & Tank (var-stabilizing transformed)") + 
    geom_point(size=3, aes(text=colnames(vsd.treat.tank))) + 
   theme_minimal()#, tooltip = "text")

# Ambient pH (8.0) tanks:  1,2,7,10,11
# Moderate pH (7.8) tanks: 3,4,9,20
# Low pH (7.5) tanks: 5,13,15,16,18

PCA.data.pH <- plotPCA(vsd.pH, intgroup=c("Treatment"), returnData=TRUE)
save(PCA.data.pH, file="../results/PCA.data.pH")
```
# PCA using prcomp, etc. to identify significant PC axes and examine potential tank effects 

```{r}

pca.princomp <- prcomp(cov(assay(vsd.pH)), scale=F) #scale=F for variance-covariance matrix
pca.eigenval(pca.princomp) #The Proporation of Variance = %variance 
pc.percent <- pca.eigenval(pca.princomp)[2,1:5]*100
screeplot(pca.princomp, bstick=TRUE) #looks like PC 1 & 2 are significant 

tab.expr <- data.frame(sample.id = colnames(assay(vsd.pH)),
    EV1.all = pca.princomp$x[,1],    # the first eigenvector
    EV2.all = pca.princomp$x[,2],    # the second eigenvector
    EV3.all = pca.princomp$x[,3],    # the first eigenvector
    EV4.all = pca.princomp$x[,4],    # the second eigenvector
    EV5.all = pca.princomp$x[,5],    # the second eigenvector
    stringsAsFactors = FALSE)
shapiro.test(pca.princomp$x) #multivariate normality not met, hmmmm  
tab.expr.annot <- left_join(tab.expr, sample.info, by=c("sample.id"="Sample")) %>% droplevels()

# GGSCATTER with ellipses and stars - PC1 PC2
ggscatter(tab.expr.annot, x="EV1.all", y="EV2.all",
          shape="Tank", col="Treatment", size=3.5, alpha=0.85, ellipse = TRUE, star.plot = TRUE) + 
           #palette = c("#4575b4","#d73027"),
  theme_minimal() + ggtitle("Adult Expression, all genes, PC1xPC2") + 
  xlab(paste("PC1 (", round(pc.percent[1], digits = 1), "%)", sep="")) + 
  ylab(paste("PC2 (", round(pc.percent[2], digits = 1), "%)", sep="")) + 
  theme(legend.position = "right") + 
  guides(colour = guide_legend(override.aes = list(size=3.5))) 


# Examine potential tank effects for each treatment 
pc.axes <- names(tab.expr.annot[2:6])
x <- c(1,1,1,1,2,2,2,3,3,4)
y <- c(2,3,4,5,3,4,5,4,5,5)

pc.plots <- vector("list", length(x))
for (i in 1:length(x)) {
pc.plots[[i]] <- 
  #ggplotly(
    ggplot(
  tab.expr.annot %>% 
  mutate(Tank_n=as.numeric(as.character(Tank))) %>% 
  mutate_at("Tank_n", function(x) {
    case_when(
      x == 1 ~ "A",
      x == 5 ~ "A",
      x == 3 ~ "A",
      x == 2 ~ "B",
      x == 13 ~ "B",
      x == 4 ~ "B",
      x == 7 ~ "C",
      x == 15 ~ "C",
      x == 9 ~ "C",
      x == 10 ~ "D",
      x == 16 ~ "D",
      x == 20 ~ "D",
      x == 11 ~ "E",
      x == 18 ~ "E")}),
  aes(x=!!as.symbol(pc.axes[x[i]]),y=!!as.symbol(pc.axes[y[i]]))) + 
  geom_point(aes(col=Treatment, shape=Tank_n, fill=Treatment), size=3.5, alpha=0.85) + 
  theme_minimal() + ggtitle(paste("PC", x[i], " x ", "PC", y[i], sep = "")) + 
  xlab(paste("PC", x[i], " (", round(pc.percent[x[i]], digits = 1), "%)", sep="")) + 
  ylab(paste("PC", y[i], " (", round(pc.percent[y[i]], digits = 1), "%)", sep="")) + 
  theme(legend.position = "right") + scale_shape_manual(values=seq(0,5))#)
}
pc.plots
```

### Heatmap of the sample-to-sample distances
Another use of the transformed data is sample clustering. Here, we apply the dist function to the transpose of the transformed count matrix to get sample-to-sample distances.

A heatmap of this distance matrix gives us an overview over similarities and dissimilarities between samples. We have to provide a hierarchical clustering hc to the heatmap function based on the sample distances, or else the heatmap function would calculate a clustering based on the distances between the rows/columns of the distance matrix.

```{r}
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")) )(255)

sampleDistss <- dist(t(assay(vsd.pH)))
sampleDistMatrixs <- as.matrix(sampleDistss)

# Here we only show pH treatment 
rownames(sampleDistMatrixs) <- vsd.pH$Treatment #set row names 
colnames(sampleDistMatrixs) <- NULL
pheatmap(sampleDistMatrixs,
         clustering_distance_rows=sampleDistss,
         clustering_distance_cols=sampleDistss,
         col=rev(colors), fontsize = 6)


# Here we also show tank number 
sampleDistss <- dist(t(assay(vsd.treat.tank)))
sampleDistMatrixs <- as.matrix(sampleDistss)

rownames(sampleDistMatrixs) <- vsd.treat.tank$Treatment_Tank #set row names 
colnames(sampleDistMatrixs) <- NULL
pheatmap(sampleDistMatrixs,
         clustering_distance_rows=sampleDistss,
         clustering_distance_cols=sampleDistss,
         col=rev(colors), fontsize = 6)

```

## Differential Expression Analysis - multifactor design 

### Run the function `DESeq` to assess differential expression 

```{r}
dds.DESeq.pH <- DESeq(dds.pH) 
```

## Any DEGs between pH treatment? 

```{r}
#colData(dds.DESeq.pH)
print("Comparison: Ambient pH vs. Moderate pH")
summary(res.pco2.AM <- results(dds.DESeq.pH, contrast=c("Treatment", "Ambient", "Moderate"), alpha=0.05))
paste("No. of genes differentially expressed (padj<0.05) by pH, Ambient vs. Moderate:",  sum(res.pco2.AM$padj < 0.05, na.rm=TRUE))

print("Comparison: Ambient pH vs. Low pH")
summary(res.pco2.AL <- results(dds.DESeq.pH, contrast=c("Treatment", "Ambient", "Low"), alpha=0.05))
paste("No. of genes differentially expressed (padj<0.05) by pH, Ambient vs. Low:",  sum(res.pco2.AL$padj < 0.05, na.rm=TRUE))

print("Comparison: Moderate pH vs. Low pH")
summary(res.pco2.ML <- results(dds.DESeq.pH, contrast=c("Treatment", "Moderate", "Low"), alpha=0.05))
paste("No. of genes differentially expressed (padj<0.05) by pH, Moderate vs. Low:",  sum(res.pco2.ML$padj < 0.05, na.rm=TRUE))
nrow(res.pco2.AM)
save(res.pco2.AM, file = "../results/deseq2/res.pco2.AM")
save(res.pco2.AL, file = "../results/deseq2/res.pco2.AL")
save(res.pco2.ML, file = "../results/deseq2/res.pco2.ML")


```

### Volcano plots 
FIX: need to figure out how to plot the Moderate vs. Low genes 

```{r}
resLFC.AM <- lfcShrink(dds.DESeq.pH, coef="Treatment_Moderate_vs_Ambient", type="apeglm")
resLFC.AL <- lfcShrink(dds.DESeq.pH, coef="Treatment_Low_vs_Ambient", type="apeglm")

plotMA(resLFC.AM, ylim=c(-6,4))
plotMA(resLFC.AL, ylim=c(-6,4))
```
### Create heatmaps with DEGs 

```{r}
#Subset the DESeq results for only those statistically sign. ones 
diffex.AM <- subset(res.pco2.AM, padj < 0.05)
diffex.AL <- subset(res.pco2.AL, padj < 0.05)
diffex.ML <- subset(res.pco2.ML, padj < 0.05)

save(diffex.AM, file = "../results/deseq2/diffex.AM")
save(diffex.AL, file = "../results/deseq2/diffex.AL")
save(diffex.ML, file = "../results/deseq2/diffex.ML")

### Generate counts matrix With DEGs among any pH treatment
diffex.pH.counts <- subset(assay(vsd.pH), rownames(dds.DESeq.pH) %in% unique(c(rownames(diffex.AM),rownames(diffex.AL),rownames(diffex.ML))))

# Create a dataframe to annotate heatmap with treatments 
dds.pH.df <- sample.info[match(colnames(diffex.pH.counts), sample.info$Sample),c("Sample", "Treatment", "Tank")] %>%
  remove_rownames() %>% column_to_rownames(var = "Sample")

# Make sure treatment order is correct
all(colnames(diffex.pH.counts) == rownames(dds.pH.df)) #double check that samples are still in same order 

# All DEGs among any pH treatment 
pheatmap(diffex.pH.counts, cluster_rows=TRUE, cluster_cols=FALSE,
         show_rownames=FALSE, na.rm=TRUE, annotation_colors = list(Treatment=c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")),
         scale="row", main = "Differentially expressed genes (DEGs) among any pH treatment", 
         annotation_col=dds.pH.df[,"Treatment", drop=FALSE], fontsize = 8)

# # another way to do a heatmap 
# heatmap(diffex.pH.counts, Colv = NA, scale="row", ColSideColors = brewer.pal(3, "Set1")[dds.pH.df$Treatment])
```

Volcano plots 

```{r}
# ----------- AMBIENT VS MODERATE 
topT <- as.data.frame(res.pco2.AM)
par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

#Adjusted P values (FDR Q values)
with(topT, plot(-1*log2FoldChange, -log10(padj), pch=16, main="Volcano plot\nAmbient pH vs. Moderate pH", cex=0.5, cex.main=1, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))

with(subset(topT, padj<0.05 & abs(-1*log2FoldChange)>2), points(-1*log2FoldChange, -log10(padj), pch=16, col="red", cex=0.75))

# with(subset(topT, padj<0.05 & abs(-1*log2FoldChange)>2), text(-1*log2FoldChange, -log10(padj), labels=subset(rownames(topT), topT$padj<0.05 & abs(topT$log2FoldChange*-1)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(topT$pvalue[topT$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)


# ----------- AMBIENT VS LOW 
topT <- as.data.frame(res.pco2.AL)
par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

#Adjusted P values (FDR Q values)
with(topT, plot(-1*log2FoldChange, -log10(padj), pch=16, main="Volcano plot\nAmbient pH vs. Low pH", cex=0.5, cex.main=1, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))

with(subset(topT, padj<0.05 & abs(-1*log2FoldChange)>2), points(-1*log2FoldChange, -log10(padj), pch=16, col="red", cex=0.75))

#with(subset(topT, padj<0.05 & abs(-1*log2FoldChange)>2), text(-1*log2FoldChange, -log10(padj), labels=subset(rownames(topT), topT$padj<0.05 & abs(topT$-1*log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(topT$pvalue[topT$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)

# ----------- MODERATE VS LOW 
topT <- as.data.frame(res.pco2.ML)
par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

#Adjusted P values (FDR Q values)
with(topT, plot(log2FoldChange, -log10(padj), pch=16, main="Volcano plot\nModerate pH vs. Low pH", cex=0.5, cex.main=1, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))

with(subset(topT, padj<0.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(padj), pch=16, col="red", cex=0.75))

#with(subset(topT, padj<0.05 & abs(log2FoldChange)>2), text(log2FoldChange, -log10(padj), labels=subset(rownames(topT), topT$padj<0.05 & abs(topT$log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(topT$pvalue[topT$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)

```


```{r}
### ----- Generate pairwise comparison heatmaps 

# Create count matrices containing DEGs for each pairwise treatment comparison, rows (genes) ordered by pvalue, 

diffex.AM.counts <- subset(assay(vsd.pH), rownames(dds.DESeq.pH) %in% rownames(diffex.AM)) %>% as.data.frame() %>%
  dplyr::select((sample.info %>% arrange(Treatment) %>% 
                   filter(Treatment=="Ambient" | Treatment== "Moderate"))$Sample) %>% 
  rownames_to_column(var = "gene") %>% arrange(match(gene, c(as.data.frame(diffex.AM) %>% arrange(padj) %>% rownames()))) %>%
  column_to_rownames(var = "gene") %>% as.matrix()
  
diffex.AL.counts <- subset(assay(vsd.pH), rownames(dds.DESeq.pH) %in% rownames(diffex.AL)) %>% as.data.frame() %>%
  dplyr::select((sample.info %>% arrange(Treatment) %>% 
                   filter(Treatment=="Ambient" | Treatment== "Low"))$Sample) %>% 
  rownames_to_column(var = "gene") %>% arrange(match(gene, c(as.data.frame(diffex.AL) %>% arrange(padj) %>% rownames()))) %>% 
  column_to_rownames(var = "gene") %>% as.matrix()

diffex.ML.counts <- subset(assay(vsd.pH), rownames(dds.DESeq.pH) %in% rownames(diffex.ML)) %>% as.data.frame() %>%
  dplyr::select((sample.info %>% arrange(Treatment) %>% 
                   filter(Treatment=="Moderate" | Treatment== "Low"))$Sample) %>% 
  rownames_to_column(var = "gene") %>%
  arrange(match(gene, c(as.data.frame(diffex.ML) %>% arrange(padj) %>% rownames()))) %>% 
  column_to_rownames(var = "gene") %>% as.matrix()


pheatmap(diffex.AM.counts, cluster_cols = FALSE, cluster_rows=TRUE, 
         show_rownames=FALSE, na.rm=TRUE, scale="row", 
         main = "DEGs among pH 8.0 (ambient) & pH 7.8 (moderate), sorted by p-value",
         fontsize = 8, cutree_rows = 2, 
         annotation_colors = list(Treatment=c(Ambient="#2c7bb6", Moderate="#fdae61")),
         annotation_col=dds.pH.df[colnames(diffex.AM.counts),"Treatment", drop=FALSE])

pheatmap(diffex.AL.counts, cluster_cols = FALSE, cluster_rows=TRUE, 
         show_rownames=FALSE, na.rm=TRUE, scale="row", 
         main = "DEGs among pH 8.0 (ambient) & pH 7.5 (low), sorted by p-value",
         fontsize = 8, cutree_rows = 2,
         annotation_colors = list(Treatment=c(Ambient="#2c7bb6", Low="#d7191c")),
         annotation_col=dds.pH.df[colnames(diffex.AL.counts),"Treatment", drop=FALSE])

pheatmap(diffex.ML.counts, cluster_cols = FALSE, cluster_rows=TRUE, 
         show_rownames=TRUE, na.rm=TRUE, scale="row", 
         main = "DEGs among pH 7.8 (moderate) & pH 7.5 (low), sorted by p-value",
         fontsize = 8, cutree_rows = 2, 
         annotation_colors = list(Treatment=c(Moderate="#fdae61", Low="#d7191c")),
         annotation_col=dds.pH.df[colnames(diffex.ML.counts),"Treatment", drop=FALSE])
```
### question - are the moderate vs. low DEGs unique? or are they similar to ambient? 
answer - not super unique 
```{r}
diffex.ML %>% rownames() %>% length() #19 DEGs between moderate & low pH 
Reduce(setdiff, list(c(diffex.ML %>% rownames()), c(diffex.AL %>% rownames()))) %>% length() # 12 of which are also different among ambient & low pH 
Reduce(setdiff, list(c(diffex.ML %>% rownames()), c(diffex.AM %>% rownames()))) %>% length() # 13 of which are also different among ambient & moderate pH
```

## Venn Diagram of DEGs by pairwise comparison 

```{r}
library(VennDiagram)

x <- list(
  AvsM = row.names(diffex.AM), 
  AvsL = row.names(diffex.AL), 
  MvsL = row.names(diffex.ML)
  )

display_venn <- function(x, ...){
  library(VennDiagram)
  grid.newpage()
  venn_object <- venn.diagram(x, filename = NULL, ...)
  grid.draw(venn_object)
}
display_venn(x)

display_venn(
        x,
        category.names = c("Ambient vs.\nModerate" , "Ambient vs.\nLow" , "Moderate vs.\nLow"),
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = c("#999999", "#E69F00", "#56B4E9"),
        # Numbers
        cex = .9,
        fontface = "italic",
        # Set names
        cat.cex = .9,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.dist = c(0.06, 0.06, 0.06)
)
```
```{r}
509/1802
319/1802
955/1802
```


### Save lists of annotated genes DEGs 

Here I merge the DEG lists with the Best Blast table, and then with my Uniprot/Swissprot annotations to get UniprotID and GO information. 

Column order in saved file is with (parentheses indicating source): 
```
- gene:               Blue king crab gene ID
- baseMean:           (DESeq2)
- log2FoldChange:     (DESeq2)
- lfcSE:              (DESeq2)
- stat:               (DESeq2)
- pvalue:             (DESeq2)
- padj:               (DESeq2)
- blast_type:         (Best blast)
- seq_length:         (Best blast)
- hit_acc:            (Best blast)
- hit_desc:           (Best blast)
- score:              (Best blast)
- e_value:            (Best blast)
- percent_ident:      (Best blast)
- percent_ident.num:  (Best blast)
- query_start:        (Best blast)
- query_end:          (Best blast)
- hit_start:          (Best blast)
- hit_end:            (Best blast)
- Start:              (Uniprot Blast)
- End:                (Uniprot Blast)
- saccver:            (Uniprot Blast)
- SPID:               (Uniprot Blast)
- gene.Uni:           (Uniprot Blast)
- evalue:             (Uniprot Blast)
- Protein names       (Uniprot Blast)
- Gene ontology (biological processes): (Uniprot Blast)
- Gene ontology IDs:  (Uniprot Blast)
```

```{r}
diffex.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% 
  left_join(P.plat.bestblast, by=c("gene"="id_gtf")) %>%
  left_join(P.plat.blast.GO %>% 
              dplyr::select(gene_id, start, end, saccver, spid, gene_uni,evalue, protein_names,
                            gene_ontology_biological_process, gene_ontology_i_ds), 
            by = c("gene"="gene_id")) %>% arrange(padj) %>% 
  write.csv(file = "../results/DEGs.Amb-vs-Mod_annotated.csv", row.names = F, quote = T)

diffex.AL %>% as.data.frame() %>% rownames_to_column("gene") %>% 
  left_join(P.plat.bestblast, by=c("gene"="id_gtf")) %>%
  left_join(P.plat.blast.GO %>% 
              dplyr::select(gene_id, start, end, saccver, spid, gene_uni,evalue, protein_names,
                            gene_ontology_biological_process, gene_ontology_i_ds), 
            by = c("gene"="gene_id")) %>% arrange(padj) %>% 
  write.csv(file = "../results/DEGs.Amb-vs-Low_annotated.csv", row.names = F, quote = T)

diffex.ML %>% as.data.frame() %>% rownames_to_column("gene") %>% 
  left_join(P.plat.bestblast, by=c("gene"="id_gtf")) %>%
  left_join(P.plat.blast.GO %>% 
              dplyr::select(gene_id, start, end, saccver, spid, gene_uni,evalue, protein_names,
                            gene_ontology_biological_process, gene_ontology_i_ds), 
            by = c("gene"="gene_id")) %>% arrange(padj) %>% 
  write.csv(file = "../results/DEGs.Mod-vs-Low_annotated.csv", row.names = F, quote = T)
  
```

## Prep for GO_MWU analysis 

#### Extract module membership values for each gene for each pH-associated module 


```{r files for GO_MWU}
# BACKGROUND - all genes submitted to DESeq2 analysis 
res.pco2.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene) %>% 
  left_join(P.plat.blast.GO %>% dplyr::select(gene_id, gene_ontology_i_ds), by = c("gene"="gene_id")) %>% 
  filter(!is.na(gene_ontology_i_ds)) %>%
  write_delim("../results/GO_MWU/DESeq-genes_for-GOMWU.tab",delim = "\t")

# DEGs between Ambient & Moderate
res.pco2.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene,log2FoldChange) %>% 
  left_join(P.plat.blast.GO %>% dplyr::select(gene_id, gene_ontology_i_ds), by = c("gene"="gene_id")) %>% 
  filter(!is.na(gene_ontology_i_ds)) %>% select(gene, log2FoldChange) %>%
  write.csv("../results/GO_MWU/DEGs_amb-mod.csv", quote = F,row.names = F)

# DEGs between Ambient & Low
res.pco2.AL %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene,log2FoldChange) %>% 
  left_join(P.plat.blast.GO %>% dplyr::select(gene_id, gene_ontology_i_ds), by = c("gene"="gene_id")) %>% 
  filter(!is.na(gene_ontology_i_ds)) %>% select(gene, log2FoldChange) %>%
  write.csv("../results/GO_MWU/DEGs_amb-low.csv", quote = F,row.names = F)

# DEGs between Moderate & Low
res.pco2.ML %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene,log2FoldChange) %>% 
  left_join(P.plat.blast.GO %>% dplyr::select(gene_id, gene_ontology_i_ds), by = c("gene"="gene_id")) %>% 
  filter(!is.na(gene_ontology_i_ds)) %>% select(gene, log2FoldChange) %>%
  write.csv("../results/GO_MWU/DEGs_mod-low.csv", quote = F,row.names = F)
```

## Prep for Ingenuity Pathway Analysis (IPA)
Need tab-delimited file with gene ID column, then for each comparison 2 columns: 1: LFC, 2) p-value 

```{r}
IPA.degs <- cbind(
res.pco2.AM %>% as.data.frame() %>% select(log2FoldChange, padj) %>% rename_with( ~ paste0("Amb_vs_Mod_", .x)),
res.pco2.AL %>% as.data.frame() %>% select(log2FoldChange, padj) %>% rename_with( ~ paste0("Amb_vs_Low_", .x)),
res.pco2.ML %>% as.data.frame() %>% select(log2FoldChange, padj) %>% rename_with( ~ paste0("Mod_vs_Low_", .x))) %>% 
  rownames_to_column("geneID")
save(IPA.degs, file = "../results/IPA/IPA.degs")

# write_delim(IPA.degs, file = "../results/deseq2/DESeq2-results-for-IPA.tab", delim = "\t", 
#               col_names = TRUE, quote = "none")
```


### Examine some of the most consistently differentially expressed genes in OA treatments 

```{r}
# Calculate per-treatment mean, sd, and cv for each gene (using variance-stabilizing normalized counts)

# first extract the normalized counts
gene.counts.norm <- assay(vsd.pH) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "gene") %>% 
  pivot_longer(-gene, values_to = "counts.vsd", names_to = "Sample") %>%
  left_join(sample.info[,c("Sample", "Treatment")]) %>% 
  mutate_at(c("gene", "Sample"), factor) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))

# calculate mean, sd, cv and annotate 
genes.stats <- gene.counts.norm %>% group_by(Treatment, gene) %>% 
  summarize(mean=mean(counts.vsd), median=median(counts.vsd), sd=sd(counts.vsd), cv=sd(counts.vsd)/mean(counts.vsd)) %>% 
  mutate(DEG=if_else(gene %in% c(rownames(diffex.AM),rownames(diffex.AL), rownames(diffex.ML)), "DEG", "Non-DEG")) %>%
  mutate(change = case_when(
  gene %in% c(rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange < 0)), rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange < 0))) ~ "Up-regulated",
  gene %in% c(rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange > 0)), rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange > 0))) ~ "Down-regulated")) %>% 
  mutate(change=replace_na(change,"Non-DEG")) %>% 
  mutate(DEG=factor(DEG, levels=c("Non-DEG", "DEG"))) %>% 
  mutate(change=factor(change, levels=c("Non-DEG", "Down-regulated", "Up-regulated"))) %>%
  ungroup() %>% 
  left_join(P.plat.bestblast %>% select(id, id_gtf, hit_acc, hit_desc, e_value), by=c("gene"="id")) %>%
  left_join(P.plat.blast.GO %>% select(gene_id, spid, protein_names, evalue), by=c("gene"="gene_id"))
save(genes.stats, file = "../results/bowtie/per-gene-summary-stats")

hist(genes.stats$mean)
hist(genes.stats$cv, breaks = 50)

# What's the range of mean of the normalized counts, what is considered high? I'd say >10
ggplot(genes.stats) + geom_boxplot(aes(x=Treatment, y=mean, colour=Treatment)) + facet_wrap(~change)

# What's the range of CV of the normalized counts, what is considered low-level variation? Q1 extends to 0.02-0.04
ggplotly(ggplot(genes.stats) + geom_boxplot(aes(x=Treatment, y=cv, colour=Treatment)) + facet_wrap(~change))

# Which genes were highly UP-regulated (mean of transformed counts >10) consistently within an OA treatment? (CV<0.04)
genes.stats %>% filter(mean>10 & cv<.02 & change=="Up-regulated" & Treatment!="Ambient") %>% View()

# Which genes were highly DOWN-regulated (mean of transformed counts >10) consistently within an OA treatment? (CV<0.04)
genes.stats %>% filter(mean>10 & cv<.02 & change=="Down-regulated" & Treatment!="Ambient") %>% View()

# To inspect counts for individual genes of interest, use this code: 
# e.g. calcium-dependent secretion activator\nevm.TU.HiC_scaffold_92.184
# e.g. heat shock protein\nevm.TU.HiC_scaffold_43.188
# e.g. peroxiredoxin\nevm.TU.HiC_scaffold_16.208
# e.g. superoxide dismutase [Mn], mitochondrial-like\nevm.TU.HiC_scaffold_64.12
# e.g. Methylcytosine dioxygenase TET1\nevm.TU.HiC_scaffold_78.1
a <-  plotCounts(dds.DESeq.pH, gene="evm.TU.HiC_scaffold_43.188", intgroup=c("Treatment"), returnData = TRUE) %>% 
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
  
ggplot(a %>% rownames_to_column("sample"),
       aes(x=Treatment, y=count, color=Treatment, label=sample)) +
  #geom_boxplot(outlier.shape = NA) +
  geom_point(size=2, position=position_jitter(w = 0.15,h = 0)) +
    #geom_text(size=2) +
    theme_bw() +
    ggtitle("heat shock protein\nevm.TU.HiC_scaffold_43.188") +
    theme(axis.title.x = element_blank(), plot.title = element_text(hjust = 0.5, size=10), legend.position = "none") +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c"))


# For DEGs - Reaction Norm Plot 
# plot mean counts for ambient, moderate, and low pH 

genes.stats %>% filter(change!="Non-DEG") %>% 
  mutate(treat.num=as.numeric(Treatment)) %>%  #need to change treatment factor to numeric for plotting 
  ggplot(aes(x=treat.num, y=mean, group=gene)) + geom_line(size=.01) +
  theme_minimal() + facet_wrap(~change) +
  scale_x_continuous(breaks=c(1,2,3), labels=c("Ambient", "Moderate", "Low")) +
  theme(axis.title.x = element_blank(), plot.title = element_text(size=10), axis.text.x = element_text(hjust = 0.2)) +
  xlab("Per-treatment mean of normalized counts") + ggtitle("Abundances of DEGs by treatment & relative expression")


```

# Exploring differences in within-group variances 

## Broad differences using multivariate approaches
- Identify centroid (mean of points on PC axes), calculate euclidean distances, compare those  
- Perform a multivariate homogeneity of variance test - betadisper from vegan package

### All genes in matrix 

```{r}
a <- plotPCA(vsd.pH, intgroup="Treatment")

# calculate centroids for each 
b <- a$data %>% group_by(Treatment) %>% summarize(PC1.mean=mean(PC1), 
                                             PC1.sd=sd(PC1),
                                             PC2.mean=mean(PC2),
                                             PC2.sd=sd(PC2))
# calculate euclidean distance from treatment centroid for each sample 
c <- a$data %>% left_join(b, by = "Treatment") %>% 
  mutate(dist.cent=sqrt((PC1-PC1.mean)^2+(PC2-PC2.mean)^2)) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
  
# examine euclidean distances from centroid 
ggplot(c, aes(x=Treatment, y=dist.cent, colour=Treatment)) + 
  geom_boxplot() + geom_jitter(width = .2) +
  ggtitle("Euclidean distances to centroid of PCA by treatment\nAll genes") +
  theme_minimal() + theme(legend.position = "none", axis.title.x = element_blank()) +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c"))

ggplot(data=c, aes(x=PC1, y=PC2, group=Treatment, colour=Treatment)) + 
  geom_point() + 
    theme_minimal()+ stat_ellipse() +
  geom_segment(aes(x=PC1.mean, y=PC2.mean, xend=PC1, yend=PC2)) +
      geom_point(aes(x=PC1.mean, y=PC2.mean,fill=Treatment), col="black", shape=22, size=4) +
   ggtitle("PCA by Treatment, All genes\n(var-stabilizing transformed)") + theme(legend.position = c(0.08, 0.85)) +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")) +
    scale_fill_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")) 

# Examine homogeneity of multivariate dispersions using all data 

# By examining distance to centroid on PCA
hist(c$dist.cent) #normal distribution? 
shapiro.test(c$dist.cent) #not really 

hist(log(c$dist.cent)) #log transformed = yes  
shapiro.test(log(c$dist.cent)) #log transformed = yes  
summary(aov(log(dist.cent)~Treatment, data=c)) # no diff
TukeyHSD(aov(log(dist.cent)~Treatment, data=c)) # no diff 


# By using the vegan package's `betadisper` function 
# This uses the sample-sample distance matrix, "sampleDistss", generated previously 
all(rownames(dds.pH.df) == attributes(sampleDistss)$Labels) # should === TRUE
print(disper <- betadisper(sampleDistss, dds.pH.df$Treatment)) 
anova(disper) #yes a difference, but how?
TukeyHSD(disper) #Dispersion varies between Ambient & Low pH treatments only 
permutest(disper, pairwise = TRUE) #another way of testing, same result
boxplot(disper)
plot(disper)
```

### DEGs only 

```{r}
degs.vst <- vst(
  DESeqDataSetFromMatrix(
    countData = counts.tk[,unique(c(rownames(diffex.AM),rownames(diffex.AL),rownames(diffex.ML)))] %>% t(),
                              colData = counts.tk[,"Treatment", drop=FALSE] ,
                              design = ~ Treatment), blind=TRUE)

a <- plotPCA(degs.vst, intgroup="Treatment")

# calculate centroids for each 
b <- a$data %>% group_by(Treatment) %>% summarize(PC1.mean=mean(PC1), 
                                             PC1.sd=sd(PC1),
                                             PC2.mean=mean(PC2),
                                             PC2.sd=sd(PC2))
# calculate euclidean distance from treatment centroid for each sample 
c <- a$data %>% left_join(b, by = "Treatment") %>% 
  mutate(dist.cent=sqrt((PC1-PC1.mean)^2+(PC2-PC2.mean)^2)) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
  
# examine euclidean distances from centroid 
ggplot(c, aes(x=Treatment, y=dist.cent, colour=Treatment)) + 
  geom_boxplot() + geom_jitter(width = .2) +
  ggtitle("Euclidean distances to centroid of PCA by treatment\nDEGs only") +
  theme_minimal() + theme(legend.position = "none", axis.title.x = element_blank()) +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c"))

ggplot(data=c, aes(x=PC1, y=PC2, group=Treatment, colour=Treatment)) + 
  geom_point() + 
    theme_minimal()+ stat_ellipse() +
  geom_segment(aes(x=PC1.mean, y=PC2.mean, xend=PC1, yend=PC2)) +
      geom_point(aes(x=PC1.mean, y=PC2.mean,fill=Treatment), col="black", shape=22, size=4) +
   ggtitle("PCA by Treatment, DEGs only\n(var-stabilizing transformed)") + theme(legend.position = c(0.08, 0.85)) +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")) +
    scale_fill_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")) 

# Examine homogeneity of multivariate dispersions using all data 

# By examining distance to centroid on PCA
hist(c$dist.cent) #normal distribution? 
shapiro.test(c$dist.cent) #not really 

hist(c$dist.cent^.5) #log transformed = yes  
shapiro.test(c$dist.cent^.5) #log transformed = yes  
summary(aov(dist.cent^.5~Treatment, data=c)) # very different 
TukeyHSD(aov(dist.cent^.5~Treatment, data=c)) # ambient diff from other treatments - more spread 


# By using the vegan package's `betadisper` function 
# Need to generate new distance matrix after selecting only DEGs 
sampleDistss.degs <- dist(t(assay(degs.vst)))

all(rownames(dds.pH.df) == attributes(sampleDistss.degs)$Labels) # should === TRUE
print(disper <- betadisper(sampleDistss.degs, dds.pH.df$Treatment)) 
anova(disper) #yes a difference, but how?
TukeyHSD(disper) #Dispersion varies between Ambient & other two factors  
permutest(disper, pairwise = TRUE) #another way of testing, same result
boxplot(disper)
plot(disper)
```

### Excluding DEGs 

```{r}
notdegs.vst <- vst(
  DESeqDataSetFromMatrix(countData = counts.tk[,-which(names(counts.tk) %in% c("Tank", "Treatment", "Treatment_Tank", rownames(diffex.AM),rownames(diffex.AL),rownames(diffex.ML)))] %>% t(),
                              colData = counts.tk[,"Treatment", drop=FALSE] ,
                              design = ~ Treatment), blind=TRUE)

a <- plotPCA(notdegs.vst, intgroup="Treatment")

# calculate centroids for each 
b <- a$data %>% group_by(Treatment) %>% summarize(PC1.mean=mean(PC1), 
                                             PC1.sd=sd(PC1),
                                             PC2.mean=mean(PC2),
                                             PC2.sd=sd(PC2))
# calculate euclidean distance from treatment centroid for each sample 
c <- a$data %>% left_join(b, by = "Treatment") %>% 
  mutate(dist.cent=sqrt((PC1-PC1.mean)^2+(PC2-PC2.mean)^2)) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
  
# examine euclidean distances from centroid 
ggplot(c, aes(x=Treatment, y=dist.cent, colour=Treatment)) + 
  geom_boxplot() + geom_jitter(width = .2) +
  ggtitle("Euclidean distances to centroid of PCA by treatment\nAll genes except DEGs") +
  theme_minimal() + theme(legend.position = "none", axis.title.x = element_blank()) +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c"))

ggplot(data=c, aes(x=PC1, y=PC2, group=Treatment, colour=Treatment)) + 
  geom_point() + 
    theme_minimal()+ stat_ellipse() +
  geom_segment(aes(x=PC1.mean, y=PC2.mean, xend=PC1, yend=PC2)) +
      geom_point(aes(x=PC1.mean, y=PC2.mean,fill=Treatment), col="black", shape=22, size=4) +
     ggtitle("PCA by Treatment, excluding DEGs\n(var-stabilizing transformed)") + theme(legend.position = c(0.08, 0.85)) +
  scale_color_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")) +
    scale_fill_manual(values = c(Ambient="#2c7bb6", Moderate="#fdae61", Low="#d7191c")) 

# Examine homogeneity of multivariate dispersions using all data 

# By examining distance to centroid on PCA
hist(c$dist.cent) #normal distribution? 
shapiro.test(c$dist.cent) #not really 

hist(c$dist.cent^.5) #sqrt-transformed = yes  
shapiro.test(c$dist.cent^.5) #sqrt transformed = yes  
summary(aov(dist.cent^.5~Treatment, data=c)) # not different at all  
TukeyHSD(aov(dist.cent^.5~Treatment, data=c)) # no differences at all 

# By using the vegan package's `betadisper` function 
# Need to generate new distance matrix after selecting only DEGs 
sampleDistss.notdegs <- dist(t(assay(notdegs.vst)))

all(rownames(dds.pH.df) == attributes(sampleDistss.notdegs)$Labels) # should === TRUE
print(disper <- betadisper(sampleDistss.notdegs, dds.pH.df$Treatment)) 
anova(disper) #yes a difference, but how?
TukeyHSD(disper) #Dispersion varies between Ambient & other two factors  
permutest(disper, pairwise = TRUE) #another way of testing, same result
boxplot(disper)
plot(disper)
```


## Gene-wise variance 

Explore coefficient of variation by treatment, and gene groups 

```{r}
# assay(vsd.pH) #variance-stabilizing transformed count matrix
# mcols(mcols(dds.DESeq.pH))$description #Description of DESeq summary stats columns
# mcols(dds.DESeq.pH) #DESeq summary stats 

# Create dataframe in long format with gene, sample number, transformed counts, and treatment 
# use assay(vsd.pH) for variance-stabilizing transformed data 
# use assay(normTransform(dds.pH)) for log2(n+1) transformation 
d <- assay(vsd.pH) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "gene") %>% 
  pivot_longer(-gene, values_to = "counts.vsd", names_to = "Sample") %>%
  left_join(sample.info[,c("Sample", "Treatment")]) %>% 
  mutate_at(c("gene", "Sample"), factor) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))

# Test for homogeneity of variances among treatments  
hist(d$counts.vsd) # first inspect transformed counts for normality - not super convincing 
shapiro.test(d$counts.vsd %>% sample(5000, replace=FALSE)) #not normal 
ks.test(x=d$counts.vsd,y='pnorm',alternative='two.sided')
leveneTest(counts.vsd ~ Treatment, data=d) #variances differ, but how? 
fligner.test(counts.vsd ~ Treatment, data=d) #variances differ, but how? 
ggplot(d, aes(x=Treatment, y=counts.vsd, colour=Treatment)) + geom_boxplot() + ggtitle("Normalized counts by treatment\nAll genes")# can't tell - no obvious difference 


# Calculate & inspect coefficient of variation for each gene within treatments 
e <- d %>% group_by(Treatment, gene) %>% 
  summarize(mean=mean(counts.vsd), sd=sd(counts.vsd), cv=sd(counts.vsd)/mean(counts.vsd))
ggplot(e, aes(x=Treatment, y=sd, colour=Treatment)) + geom_violin() +geom_boxplot() + ggtitle("Standard deviation by treatment\nAll genes")
ggplot(e, aes(x=Treatment, y=cv, colour=Treatment)) + geom_violin() +geom_boxplot() + ggtitle("CV by treatment\nAll genes")
ggplot(e, aes(x=Treatment, y=log(cv), colour=Treatment)) + geom_violin() +geom_boxplot() + ggtitle("log(CV) by treatment\nAll genes")
ggplot(e, aes(x=mean, y=cv, colour=Treatment)) + geom_point(size=1) + facet_wrap(~Treatment) + theme_minimal() + ggtitle("Coefficient of variation of counts (normalized) by treatment\nAll genes")

# inspect cv by treatment - Genes that are differentially expressed between Ambient and the two pH treatments only. 
# NOTE: this does not include genes that are diff. expressed between moderate and low pH (only a handful, though)
f <- e %>% mutate(DEG=if_else(gene %in% c(rownames(diffex.AM),rownames(diffex.AL), rownames(diffex.ML)), "DEG", "Non-DEG")) %>%
  mutate(change = case_when(
  gene %in% c(rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange < 0)), rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange < 0))) ~ "Up-regulated",
  gene %in% c(rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange > 0)), rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange > 0))) ~ "Down-regulated")) %>% 
  mutate(change=replace_na(change,"Non-DEG")) %>% 
  mutate(DEG=factor(DEG, levels=c("Non-DEG", "DEG"))) %>% 
  mutate(change=factor(change, levels=c("Non-DEG", "Down-regulated", "Up-regulated"))) %>%
  ungroup() %>% 
  left_join(P.plat.bestblast %>% select(id, id_gtf, hit_acc, hit_desc, e_value), by=c("gene"="id")) %>%
  left_join(P.plat.blast.GO %>% select(gene_id, spid, protein_names, evalue), by=c("gene"="gene_id"))

# create vector of gene names that are diff. expressed among moderate and low pH - not included in this variance comparison
remove <- (f %>% ungroup() %>% filter(DEG=="DEG") %>% filter(change=="Non-DEG"))$gene %>% as.vector()

ggplot(f %>% filter(!c(gene %in% remove)), aes(x=Treatment, y=log(cv), colour=Treatment)) + 
  geom_boxplot() + facet_wrap(~change) + theme_cleveland() + 
  theme(axis.title.x = element_blank()) + ylab("Log(Coeff. variation of transformed counts)") + 
  ggtitle("Gene-wise variance within treatments\nNon-DEGs, and DEGs that are down- and up-regulated in OA") +
  theme(axis.text.x = element_blank(), plot.title = element_text(size=10), legend.position = "bottom")

#ggplotly(
  ggplot(f, 
       aes(x=mean, y=sd, colour=Treatment)) + geom_point(size=1, aes(text=hit_acc)) + facet_wrap(~Treatment+change) + 
  theme_minimal() + theme(plot.title = element_text(size=11), legend.position = "bottom") + 
  ylab("Standard deviation of transformed gene counts") + xlab("Mean of transformed counts") +
  ggtitle("Per-gene variation within treatments (SD) ~ mean of transformed")#, tooltip = "text")

# What are those highly variable genes that are upregulated in moderate and low pH? 
f %>% filter(Treatment!="Ambient") %>% filter(DEG=="DEG") %>% filter(change=="Up-regulated") %>% filter(sd>=1) %>% View()

# What are those genes that are upregulated in moderate and low pH at very consisten levels (very low variability)? These would be critical for function.  

# First define a "low variability" threshold 
ggplotly(ggplot(f %>% filter(!c(gene %in% remove)), aes(x=Treatment, y=cv, colour=Treatment)) + 
  geom_boxplot() + facet_wrap(~change) + theme_cleveland() + 
  theme(axis.title.x = element_blank()) + ylab("Log(Coeff. variation of transformed counts)") + 
  ggtitle("Gene-wise variance within treatments\nNon-DEGs, and DEGs that are down- and up-regulated in OA") +
  theme(axis.text.x = element_blank(), plot.title = element_text(size=10), legend.position = "bottom"))

# Q1 = 0.02 - 0.03, use that 
f %>% filter(Treatment!="Ambient") %>% filter(DEG=="DEG") %>% filter(change=="Up-regulated") %>% filter(cv<=0.02) %>% View()

# Here I save a list of upregulated DEGs that are also expressed at highly consistent levels (very low variability, CV <0.03).
# Note that they have been annotated twice, first with the Best Blast results, second with my Uniprot/Swissprot blast results 
f %>% filter(Treatment!="Ambient") %>% filter(DEG=="DEG") %>% filter(change=="Up-regulated") %>% filter(cv<=0.02) %>% 
    write.csv(file = "../results/DEGs.up-low-variability_annotated.csv", row.names = F, quote = T, col.names = T)

# NOTE: When I do NOT filter out low-frequency genes prior to the DESeq2 analysis using the mean=10 threshold, some cv=0 for some genes/treatments
# So I will remove the CV=0 genes before testing for differences 
f %>% filter(cv!=0)
hist(log((f %>% filter(cv!=0))$cv))
summary(aov(log(cv) ~ DEG*Treatment, data=f %>% filter(cv!=0)))
TukeyHSD(aov(log2(cv) ~ DEG+Treatment+DEG:Treatment, data=f %>% filter(cv!=0)))

# # Here you can plot the normalized gene counts for those genes. 
# cv.zero <- (f %>% filter(cv==0))$gene %>% as.vector()
# diff_plots = list()
# for (i in 1:length(cv.zero)) {
# a <-  plotCounts(dds.DESeq.pH, gene=cv.zero[i], intgroup=c("Treatment"), returnData = TRUE)
# b <- ggplot(a %>% filter(Treatment==c("Ambient", "Moderate", "Low")) 
#                          %>% rownames_to_column("sample"),
#        aes(x=Treatment, y=count, color=Treatment, label=sample)) +
#   geom_point(position=position_jitter(w = 0.1,h = 0)) +
#     geom_text() +
#     theme_bw() +
#     ggtitle(cv.zero[i]) +
#     theme(plot.title = element_text(hjust = 0.5))
# diff_plots[[i]] <- b
# }
# diff_plots

# evm.TU.HiC_scaffold_78.1 - Methylcytosine dioxygenase TET1 (EC 1.14.11.n2) (CXXC-type zinc finger protein 6) 
a <-  plotCounts(dds.DESeq.pH, gene="evm.TU.HiC_scaffold_81.370", intgroup=c("Treatment"), returnData = TRUE) %>% 
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
  
ggplot(a %>% rownames_to_column("sample"),
       aes(x=Treatment, y=count, color=Treatment, label=sample)) +
  #geom_boxplot(outlier.shape = NA) +
  geom_point(size=2, position=position_jitter(w = 0.15,h = 0)) +
    #geom_text(size=2) +
    theme_bw() +
    #ggtitle("Methylcytosine dioxygenase TET1\nevm.TU.HiC_scaffold_78.1") +
    theme(axis.title.x = element_blank(), plot.title = element_text(hjust = 0.5, size=10), legend.position = "none")

```




# BONEYARD 

# Enrichment analysis using DAVID

Here I will do a quick enrichment analysis using the online tool DAVID. I copy the Uniprot SPIDs for the annotated DEGs and all annotated genes examined into the DAVID Functional Annotation Tools. I do so for each pairwise pH comparison. 

```{r, eval=FALSE}
# DEGs between Ambient & Moderate
diffex.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(geneID, SPID), by = c("gene"="geneID")) %>% 
  dplyr::select(SPID) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

# AMBIENT VS. LOW
diffex.AL %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(geneID, SPID), by = c("gene"="geneID")) %>% 
  dplyr::select(SPID) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

# MODERATE VS LOW 
diffex.ML %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(geneID, SPID), by = c("gene"="geneID")) %>% 
  dplyr::select(SPID) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

# BACKGROUND
res.pco2.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(geneID, SPID), by = c("gene"="geneID")) %>% 
  dplyr::select(SPID) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()


# TRY TO USE THE BEST BLAST ANNOTATION TABLE 
# DEGs between Ambient & Moderate
diffex.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(id, blast_type, hit_acc, hit_desc), by = c("gene"="id")) %>% #filter(blast_type=="BLASTX1") %>% 
  separate(hit_acc, sep = "\\.", into = c("accession","version"), remove = F) %>%
  dplyr::select(accession) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

# DEGs between Ambient & Low
diffex.AL %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(id, hit_acc, hit_desc), by = c("gene"="id")) %>% 
  dplyr::select(hit_acc) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

# DEGs between Moderate & Low (includes just 4 annotated genes) 
diffex.ML %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(id, hit_acc, hit_desc), by = c("gene"="id")) %>% 
  dplyr::select(hit_acc) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

# All genes (background, includes 7,153 annotated genes)
res.pco2.AM %>% as.data.frame() %>% rownames_to_column("gene") %>% dplyr::select(gene, padj) %>% 
  left_join(P.plat.blast %>% dplyr::select(id, hit_acc, hit_desc), by = c("gene"="id")) %>% 
  dplyr::select(hit_acc) %>%  na.omit() %>% unlist() %>% as.vector() %>% write_clip()

P.plat.blast %>% filter(blast_type=="BLASTN1")

```


## DAVID Results 
# NEED TO UPDATE LOCATIONS DEPENDING ON BOWTIE2 OR STAR 

Enriched biological processes (and associated gene lists) are saved to GitHub. These have been updated to remove outlier sample (Tank 7 Crab 4).  

-- Ambient pH vs. Moderate pH, [results/david/DAVID-Enriched-BP_Amb-Mod_no-outlier-T7C4.txt](https://raw.githubusercontent.com/laurahspencer/red-king_RNASeq-2022/main/results/david/DAVID-Enriched-BP_Amb-Mod_no-outlier-T7C4.txt)  
-- Ambient pH vs. Moderate pH, [results/david/DAVID-Enriched-BP_Amb-Low_no-outlier-T7C4.txt](https://raw.githubusercontent.com/laurahspencer/red-king_RNASeq-2022/main/results/david/DAVID-Enriched-BP_Amb-Low_no-outlier-T7C4.txt)  
-- Moderate pH vs. Low pH, NONE 


Visualize with REVIGO - read in DAVID enrichment results, extract GO terms and PValues and copy to clipboard to paste into [REVIGO](http://revigo.irb.hr/)  

```{r, eval=FALSE}
# With Bowtie2 aligned
# Between ambient and moderate pH 
read_delim(file="../results/bowtie/DAVID-Enriched-BP_Amb-Mod_no-outlier-T7C4.txt", delim = "\t") %>% 
  mutate(GO = str_extract(Term, "GO(.*?)~")) %>% 
  mutate(GO = gsub("~", "", GO)) %>% dplyr::select(GO, PValue) %>% na.omit() %>% write_clip()

# Between ambient and low pH 
read_delim(file="../results/bowtie/DAVID-Enriched-BP_Amb-Low_no-outlier-T7C4.txt", delim = "\t") %>% 
  mutate(GO = str_extract(Term, "GO(.*?)~")) %>% 
  mutate(GO = gsub("~", "", GO)) %>% dplyr::select(Term) %>% na.omit() %>% write_clip()

# Between moderate and low pH 
read_delim(file="../results/bowtie/DAVID-Enriched-BP_Mod-Low_no-outlier-T7C4.txt", delim = "\t") %>% 
  mutate(GO = str_extract(Term, "GO(.*?)~")) %>% 
  mutate(GO = gsub("~", "", GO)) %>% dplyr::select(GO, PValue) %>% na.omit() %>% write_clip()

# With STAR aligned 
read_delim(file="../results/star/star.v2/DAVID-Enriched-BP_Amb-Mod_no-outlier-T7C4.txt", delim = "\t") %>% 
  mutate(GO = str_extract(Term, "GO(.*?)~")) %>% 
  mutate(GO = gsub("~", "", GO)) %>% dplyr::select(GO, PValue) %>% na.omit() %>% write_clip()

read_delim(file="../results/star/star.v2/DAVID-Enriched-BP_Amb-Low_no-outlier-T7C4.txt", delim = "\t") %>% 
  mutate(GO = str_extract(Term, "GO(.*?)~")) %>% 
  mutate(GO = gsub("~", "", GO)) %>% dplyr::select(GO, PValue) %>% na.omit() %>% write_clip()

read_delim(file="../results/star/star.v2/DAVID-Enriched-BP_Mod-Low_no-outlier-T7C4.txt", delim = "\t") %>% 
  mutate(GO = str_extract(Term, "GO(.*?)~")) %>% 
  mutate(GO = gsub("~", "", GO)) %>% dplyr::select(GO, PValue) %>% na.omit() %>% write_clip()
```




### Are genes that are upregulated in response to OA more or less variable in those treatments compared to in the ambient crab? 

```{r}
rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange < 0)) #UPregulated in moderate OA compared to Ambient 
rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange > 0)) #DOWNregulated in moderate OA compared to Ambient 

rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange < 0)) #UPregulated in LOW OA compared to Ambient 
rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange > 0)) #DOWNregulated in LOW OA compared to Ambient 

rownames(subset(res.pco2.ML, padj < 0.05 & log2FoldChange < 0)) #UPregulated in LOW OA compared to Moderate 
rownames(subset(res.pco2.ML, padj < 0.05 & log2FoldChange > 0)) #DOWNregulated in LOW OA compared to Moderate 

# Here I define which genes I want to look at so I can characterize the up/down regulation 
# test <- rownames(subset(res.pco2.ML, padj < 0.05 & log2FoldChange > 0))

diff_plots = list()
for (i in 1:length(test)) {
a <-  plotCounts(dds.DESeq.pH, gene=test[i], intgroup=c("Treatment"), returnData = TRUE)
b <- ggplot(a %>% filter(Treatment==c("Moderate", "Low")) 
                         %>% rownames_to_column("sample"),
       aes(x=Treatment, y=count, color=Treatment, label=sample)) +
  geom_point(position=position_jitter(w = 0.1,h = 0)) +
    geom_text() +
    theme_bw() +
    ggtitle(test[i]) +
    theme(plot.title = element_text(hjust = 0.5))
diff_plots[[i]] <- b
}
diff_plots 

# ======================
## For genes that are UPREGULATED in moderate pH or low pH compared to ambient, how does dispersion compare? Look at PCAs first 
updegs.vst <- varianceStabilizingTransformation(
  DESeqDataSetFromMatrix(
    countData = counts.tk[,unique(c(rownames(subset(res.pco2.AM, padj < 0.05 & log2FoldChange < 0)),
                                    rownames(subset(res.pco2.AL, padj < 0.05 & log2FoldChange < 0))))] %>% t(),
                              colData = counts.tk[,"Treatment", drop=FALSE] ,
                              design = ~ Treatment), blind=TRUE)

a <- plotPCA(updegs.vst, intgroup="Treatment")

# calculate centroids for each 
b <- a$data %>% group_by(Treatment) %>% summarize(PC1.mean=mean(PC1), 
                                             PC1.sd=sd(PC1),
                                             PC2.mean=mean(PC2),
                                             PC2.sd=sd(PC2))
# calculate euclidean distance from treatment centroid for each sample 
c <- a$data %>% left_join(b, by = "Treatment") %>% 
  mutate(dist.cent=sqrt((PC1-PC1.mean)^2+(PC2-PC2.mean)^2)) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient", "Moderate", "Low")))
  
# examine euclidean distances from centroid 
ggplot(c, aes(x=Treatment, y=dist.cent, colour=Treatment)) + 
  geom_boxplot() + geom_jitter(width = .2) +
  ggtitle("Euclidean distances to centroid of PCA by treatment\nUpregulated genes in OA only") +
  theme_minimal() + theme(legend.position = "none", axis.title.x = element_blank())
hist(c$dist.cent) #normal distribution? 
shapiro.test(c$dist.cent) #not really 

hist(c$dist.cent^.5) #log transformed = yes  
shapiro.test(c$dist.cent^.5) #log transformed = yes  
summary(aov(dist.cent^.5~Treatment, data=c)) # no diff 
TukeyHSD(aov(dist.cent^.5~Treatment, data=c)) # no sign. diff

ggplot(data=c, aes(x=PC1, y=PC2, group=Treatment, colour=Treatment)) + 
  geom_point() + 
    theme_minimal()+ stat_ellipse() +
  geom_segment(aes(x=PC1.mean, y=PC2.mean, xend=PC1, yend=PC2)) +
      geom_point(aes(x=PC1.mean, y=PC2.mean,fill=Treatment), col="black", shape=22, size=4) +
   ggtitle("PCA by Treatment, genes upregulated in OA\n(var-stabilizing transformed)") + theme(legend.position = c(0.08, 0.85))


# ======================
## For genes that are DOWNREGULATED in moderate pH or low pH compared to ambient, how does dispersion compare? Look at PCAs first 
downdegs.vst <- varianceStabilizingTransformation(
  DESeqDataSetFromMatrix(
    countData = counts.tk[,unique(c(rownames(subset(res.pco2.AM, padj > 0.05 & log2FoldChange < 0)),
                                    rownames(subset(res.pco2.AL, padj > 0.05 & log2FoldChange < 0))))] %>% t(),
                              colData = counts.tk[,"Treatment", drop=FALSE] ,
                              design = ~ Treatment), blind=TRUE)

a <- plotPCA(downdegs.vst, intgroup="Treatment")

# calculate centroids for each 
b <- a$data %>% group_by(Treatment) %>% summarize(PC1.mean=mean(PC1), 
                                             PC1.sd=sd(PC1),
                                             PC2.mean=mean(PC2),
                                             PC2.sd=sd(PC2))
# calculate euclidean distance from treatment centroid for each sample 
c <- a$data %>% left_
  mutate(dist.cent=sqrt((PC1-PC1.mean)^2+(PC2-PC2.mean)^2)) %>%
  mutate(Treatment=factor(Treatment, levels=c("Ambient",join(b, by = "Treatment") %>%  "Moderate", "Low")))
  
# examine euclidean distances from centroid 
ggplot(c, aes(x=Treatment, y=dist.cent, colour=Treatment)) + 
  geom_boxplot() + geom_jitter(width = .2) +
  ggtitle("Euclidean distances to centroid of PCA by treatment\nDownregulated genes only") +
  theme_minimal() + theme(legend.position = "none", axis.title.x = element_blank())
hist(c$dist.cent) #normal distribution? 
shapiro.test(c$dist.cent) #not really 

hist(c$dist.cent^.5) #log transformed = yes  
shapiro.test(c$dist.cent^.5) #log transformed = yes  
summary(aov(dist.cent^.5~Treatment, data=c)) # no diff 
TukeyHSD(aov(dist.cent^.5~Treatment, data=c)) # no sign. diff

ggplot(data=c, aes(x=PC1, y=PC2, group=Treatment, colour=Treatment)) + 
  geom_point() + 
    theme_minimal()+ stat_ellipse() +
  geom_segment(aes(x=PC1.mean, y=PC2.mean, xend=PC1, yend=PC2)) +
      geom_point(aes(x=PC1.mean, y=PC2.mean,fill=Treatment), col="black", shape=22, size=4) +
   ggtitle("PCA by Treatment, genes downregulated in OA\n(var-stabilizing transformed)") + theme(legend.position = c(0.08, 0.85))
```

## Redo all-gene heat map and PCAs with the low-frequency genes (identified in the DEG analysis) removed

```{r}
a <- c(res.pco2.AM %>% as.data.frame() %>% filter(is.na(padj)) %>% rownames())
b <- c(res.pco2.AL %>% as.data.frame() %>% filter(is.na(padj)) %>% rownames())
c <- c(res.pco2.ML %>% as.data.frame() %>% filter(is.na(padj)) %>% rownames())
d <- Reduce(setdiff, list(a,b,c))

test <- assay(vsd.pH) %>% as.data.frame() %>% rownames_to_column(var = "gene") %>% filter(!gene %in% d) %>% head(n=100) %>% column_to_rownames(var = "gene") %>% t()

pheatmap(test, Rowv=NA, Colv=NA, na.rm = TRUE, xlab = NA, 
                     show_colnames =FALSE, cluster_cols = FALSE, cluster_rows = TRUE, 
                     scale="column", color=c("dodgerblue3", "goldenrod1"), 
                     main = "RKC gene counts", annotation_row=counts.tk[,c("Treatment", "Tank")])
```

